name: Build and Publish amass go-mod distfile (manual dispatch)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Amass version (e.g. 5.0.1)"
        required: true

permissions:
  contents: write

jobs:
  deps:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout upstream amass
        uses: actions/checkout@v4
        with:
          repository: owasp-amass/amass
          ref: "v${{ github.event.inputs.version }}"
          path: amass

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "amass/go.mod"

      - name: Generate go-mod cache
        working-directory: amass
        run: |
          rm -rf go-mod
          GOMODCACHE="${PWD}/go-mod" go mod download -modcacherw

      - name: Create deps tarball
        working-directory: amass
        run: |
          XZ_OPT='-T0 -9' tar -acf "amass-${{ github.event.inputs.version }}-deps.tar.xz" go-mod
          sha256sum "amass-${{ github.event.inputs.version }}-deps.tar.xz" > "amass-${{ github.event.inputs.version }}-deps.tar.xz.sha256"

      - name: Create/Update GitHub Release and upload asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "amass-${{ github.event.inputs.version }}"
          name: "amass deps ${{ github.event.inputs.version }}"
          files: |
            amass/amass-${{ github.event.inputs.version }}-deps.tar.xz
            amass/amass-${{ github.event.inputs.version }}-deps.tar.xz.sha256
