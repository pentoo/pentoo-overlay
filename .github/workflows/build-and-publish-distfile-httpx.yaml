name: Build and Publish httpx go-mod distfile (manual dispatch)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "httpx version (e.g. 1.8.1)"
        required: true

permissions:
  contents: write

jobs:
  deps:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout upstream httpx
        uses: actions/checkout@v4
        with:
          repository: projectdiscovery/httpx
          ref: "v${{ github.event.inputs.version }}"
          path: httpx

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "httpx/go.mod"

      - name: Generate go-mod cache
        working-directory: httpx
        run: |
          rm -rf go-mod
          GOMODCACHE="${PWD}/go-mod" go mod download -modcacherw

      - name: Create deps tarball
        working-directory: httpx
        run: |
          XZ_OPT='-T0 -9' tar -acf "httpx-${{ github.event.inputs.version }}-deps.tar.xz" go-mod
          sha256sum "httpx-${{ github.event.inputs.version }}-deps.tar.xz" > "httpx-${{ github.event.inputs.version }}-deps.tar.xz.sha256"

      - name: Create/Update GitHub Release and upload asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "httpx-${{ github.event.inputs.version }}"
          name: "httpx deps ${{ github.event.inputs.version }}"
          files: |
            httpx/httpx-${{ github.event.inputs.version }}-deps.tar.xz
            httpx/httpx-${{ github.event.inputs.version }}-deps.tar.xz.sha256
